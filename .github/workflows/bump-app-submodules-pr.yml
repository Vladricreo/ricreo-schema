name: Bump app submodule pointers (PR)

on:
  push:
    branches: ["main", "develop"]

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app_repo: ["Ricreo-print-farm", "Ricreo-Inventory"]

    env:
      OWNER: Vladricreo
      SCHEMA_URL: https://github.com/Vladricreo/ricreo-schema.git
      BOT_BRANCH_PREFIX: chore/bump-schema
      SUBMODULE_PATH: client/prisma/schema

    steps:
      - name: Checkout schema (for SHA)
        uses: actions/checkout@v4

      - name: Install gh
        run: |
          type -p gh >/dev/null || (sudo apt-get update && sudo apt-get install -y gh)

      - name: Decide target branch
        id: target
        run: |
          echo "target_branch=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Clone app repo
        env:
          TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          git clone https://x-access-token:${TOKEN}@github.com/${OWNER}/${{ matrix.app_repo }}.git app

      - name: Prepare bump branch and update submodule pointer
        env:
          TOKEN: ${{ secrets.SYNC_TOKEN }}
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          set -euo pipefail
          cd app
          git fetch origin

          TARGET="${{ steps.target.outputs.target_branch }}"

          # Se il branch target non esiste, crealo da origin/main (e pushalo)
          if ! git show-ref --verify --quiet "refs/remotes/origin/${TARGET}"; then
            echo "Branch ${TARGET} non esiste su ${OWNER}/${{ matrix.app_repo }} -> lo creo da origin/main"
            git checkout -b "${TARGET}" "origin/main"
            git push -u origin "${TARGET}"
          else
            git checkout "${TARGET}"
          fi

          SCHEMA_SHA="${GITHUB_SHA}"
          BOT_BRANCH="${BOT_BRANCH_PREFIX}-${TARGET}-${SCHEMA_SHA:0:8}"
          git checkout -b "${BOT_BRANCH}"

          # ðŸ” FAI USARE IL TOKEN ANCHE AI SUBMODULE
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "git@github.com:"

          # init submodules
          git submodule update --init --recursive

          # forza url corretta del submodule (nome = client/prisma/schema)
          git config -f .gitmodules submodule.client/prisma/schema.url "${SCHEMA_URL}"
          git submodule sync --recursive
          git submodule update --init --recursive

          # punta il submodule allo SHA dello schema
          cd "${SUBMODULE_PATH}"
          git fetch origin
          git checkout "${SCHEMA_SHA}"
          cd - >/dev/null

          git add .gitmodules "${SUBMODULE_PATH}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(schema): bump ricreo-schema to ${SCHEMA_SHA}" || exit 0

          git push -u origin "${BOT_BRANCH}"

          gh pr create \
            --repo "${OWNER}/${{ matrix.app_repo }}" \
            --base "${TARGET}" \
            --head "${BOT_BRANCH}" \
            --title "chore(schema): bump ricreo-schema (${SCHEMA_SHA:0:8})" \
            --body "Aggiorna il submodule ${SUBMODULE_PATH} al commit ${SCHEMA_SHA} di Vladricreo/ricreo-schema." \
            || true
ommit ${SCHEMA_SHA} di Vladricreo/ricreo-schema." \
            || true
