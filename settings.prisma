/// Modello per le impostazioni globali dell'applicazione, gestite come coppie chiave-valore.
model InventorySettings {
  id    String       @id @default(uuid()) @db.Uuid
  name  SettingsName @unique
  value Json

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("Settings")
  @@schema("inventory")
}

/// Nomi univoci per le impostazioni dell'applicazione.
enum SettingsName {
  PROFIT_MARGIN
  LABOR_COST
  THEME
  LANGUAGE
  VAT_RATE
  STOCK_THRESHOLD
  /// Finestra temporale (in giorni) per la sync delle spedizioni (ShippyPro -> DB).
  /// Usata da `POST /api/shipments/sync` per decidere da quanto indietro importare.
  SHIPMENTS_SYNC_DAYS
  AMAZON_RESTOCK_TIME
  AMAZON_OPTIMAL_STOCK_DAYS
  FBM_OPTIMAL_STOCK_DAYS
  PRODUCTION_ORDER_AUTOMATION
  AMAZON_ORDER_FIXED_COST
  AMAZON_STORAGE_FEE_LOW
  AMAZON_STORAGE_FEE_HIGH
  /// Credenziali SP-API/LWA (cifrate a DB) usate per import Amazon (solo admin).
  AMAZON_SP_API_CREDENTIALS

  @@schema("inventory")
}

/// Stampante gestita tramite CUPS (tipicamente su Raspberry Pi).
/// Serve per stampanti etichette (label) o stampanti a fogli (A4/A5 ecc.).
model CupsPrinter {
  id String @id @default(uuid()) @db.Uuid

  /// Nome leggibile in UI (es. "Zebra GK420d - Banco 1").
  name String

  /// Nome stampante in CUPS (queue name), es. "zebra_gk420d".
  cupsName String @unique

  /// URL base del server CUPS (es. "http://raspberrypi.local:631").
  /// Se NULL si usa la variabile d'ambiente (CUPS_BASE_URL) lato server.
  cupsServerUrl String?

  kind         CupsPrinterKind @default(LABEL)
  imageUrl     String?
  description  String?
  location     String?
  isDefault    Boolean         @default(false)
  isArchived   Boolean         @default(false)

  /// Capacità/funzionalità dichiarative (non garantite) utili alla UI.
  supportsColor Boolean @default(false)

  /// DPI preferiti per la stampa etichette (se applicabile).
  preferredDpi Int?

  /// Opzioni CUPS predefinite per i job (es. { "FitToPage": "true" } ).
  /// Vengono mergeate con le opzioni del singolo job.
  defaultJobOptions Json @default("{}")

  /// Formato etichetta predefinito per questa stampante (se label).
  defaultLabelFormatId String?          @db.Uuid
  defaultLabelFormat   CupsLabelFormat? @relation("DefaultLabelFormat", fields: [defaultLabelFormatId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// Formati etichetta compatibili/consigliati per questa stampante.
  labelFormats CupsLabelFormat[] @relation("PrinterLabelFormats")

  /// Profili di stampa che puntano a questa stampante (routing per tipo job).
  printProfiles CupsPrintProfile[] @relation("PrintProfilePrinter")

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([kind])
  @@index([isArchived])
  @@index([isDefault])
  @@schema("inventory")
}

/// Preset/definizione di un formato etichetta (dimensioni in mm).
/// È indipendente dalla stampante: può essere riutilizzato e associato a più stampanti.
model CupsLabelFormat {
  id String @id @default(uuid()) @db.Uuid

  /// Nome leggibile (es. "40x30 - Amazon FNSKU").
  name String @unique

  /// Larghezza/altezza in mm.
  widthMm  Decimal @db.Decimal(8, 2)
  heightMm Decimal @db.Decimal(8, 2)

  /// Gap/spacing tra etichette (mm). Utile per roll con etichette pretagliate.
  gapMm Decimal? @db.Decimal(8, 2)

  /// Margini (mm) se vuoi lasciare area “vuota” sul supporto.
  marginTopMm    Decimal? @db.Decimal(8, 2)
  marginRightMm  Decimal? @db.Decimal(8, 2)
  marginBottomMm Decimal? @db.Decimal(8, 2)
  marginLeftMm   Decimal? @db.Decimal(8, 2)

  /// Rotazione/Orientamento preferito.
  orientation CupsLabelOrientation @default(PORTRAIT)

  /// Media name CUPS (es. "Custom.40x30mm" oppure un nome standard come "iso_a4_210x297mm").
  /// Se NULL verrà calcolato come Custom.<W>x<H>mm.
  cupsMediaName String?

  /// Opzioni job suggerite per questo formato (es. scaling/fit-to-page).
  jobOptions Json @default("{}")

  /// Stampanti associate (molti-a-molti).
  printers CupsPrinter[] @relation("PrinterLabelFormats")

  /// Stampanti che lo usano come default (relazione 1:N via FK su CupsPrinter).
  defaultForPrinters CupsPrinter[] @relation("DefaultLabelFormat")

  /// Profili di stampa che puntano a questo formato (routing per tipo job).
  printProfiles CupsPrintProfile[] @relation("PrintProfileLabelFormat")

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@schema("inventory")
}

enum CupsPrinterKind {
  LABEL
  SHEET

  @@schema("inventory")
}

enum CupsLabelOrientation {
  PORTRAIT
  LANDSCAPE

  @@schema("inventory")
}

/// Tipologia di job di stampa gestita dall'app (routing: quale stampante + quale formato usare).
/// Serve per impostare default diversi per casi d'uso (es. spedizioni vs item vs odette).
enum CupsPrintJobKind {
  /// Etichetta di spedizione (tipicamente 4x6).
  SHIPMENT_LABEL
  /// Etichetta per item (es. 30x50).
  ITEM_LABEL
  /// Etichetta per odette (es. 60x50).
  ODETTE_LABEL

  /// Etichetta per prodotti (es. 60x50).
  PRODUCT_LABEL

  @@schema("inventory")
}

/// Profilo di stampa per una specifica tipologia di job.
/// Consente di associare una stampante e (opzionalmente) un formato etichetta.
model CupsPrintProfile {
  id String @id @default(uuid()) @db.Uuid

  /// Tipologia del job (univoca).
  kind CupsPrintJobKind

  /// Stampante selezionata per questa tipologia di job.
  printerId String?     @db.Uuid
  printer   CupsPrinter? @relation("PrintProfilePrinter", fields: [printerId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// Formato etichetta selezionato per questa tipologia di job.
  /// Se NULL, il sistema può usare il default della stampante (se presente).
  labelFormatId String?          @db.Uuid
  labelFormat   CupsLabelFormat? @relation("PrintProfileLabelFormat", fields: [labelFormatId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// Opzioni CUPS specifiche per questo profilo (mergeate con stampante/formato/job).
  jobOptions Json @default("{}")

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([kind])
  @@index([printerId])
  @@index([labelFormatId])
  @@schema("inventory")
}
