/// Severità della notifica (utile per UI e filtri).
enum NotificationSeverity {
  INFO
  SUCCESS
  WARNING
  ERROR

  @@schema("public")
}

/// Tipologia di notifica (macro-categorie applicative).
/// Nota: aggiungiamo valori man mano che emergono casi d'uso reali.
enum NotificationType {
  SYSTEM
  INVENTORY
  PRODUCTION
  ASSEMBLY
  PURCHASING
  SALES
  IMPORT
  AUTH

  @@schema("public")
}

/// Notifica applicativa persistita a DB.
/// Pattern:
/// - `Notification` contiene il contenuto e metadata comuni
/// - `NotificationRecipient` traccia lo stato per-utente (letto, archiviato, ecc.)
model Notification {
  id String @id @default(uuid()) @db.Uuid

  type     NotificationType
  severity NotificationSeverity @default(INFO)

  /// Titolo breve, ideale per list item / toast.
  title String
  /// Corpo esteso (opzionale). Se serve solo il titolo, lascia null.
  body  String?

  /// Deep-link interno (path) per aprire la schermata correlata.
  /// Esempio: "/inventory/movements?movementId=..."
  url String?

  /// Chi ha generato la notifica (se applicabile).
  createdByUserId Int?
  createdBy       User? @relation("NotificationCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// Payload libero per metadati specifici (es. { entity: { type, id }, diff, ... }).
  data Json?

  /// Chiave di deduplicazione opzionale (idempotenza).
  /// Esempio: "inventory:low-stock:SKU123" per evitare spam.
  dedupeKey String? @unique

  /// Se valorizzata, la notifica è considerata "scaduta" e può essere esclusa dalle query.
  expiresAt DateTime? @db.Timestamptz(6)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  recipients NotificationRecipient[]

  @@index([type])
  @@index([severity])
  @@index([createdAt(sort: Desc)])
  @@index([createdByUserId])
  @@index([expiresAt])
  @@schema("public")
}

/// Stato di una notifica per uno specifico utente.
model NotificationRecipient {
  id String @id @default(uuid()) @db.Uuid

  notificationId String       @db.Uuid
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  /// Flag comodo per filtri rapidi.
  isRead Boolean   @default(false)
  /// Timestamp lettura (se `isRead=true`).
  readAt DateTime? @db.Timestamptz(6)

  /// Timestamp archiviazione (se valorizzato la notifica non appare nel feed "attivo").
  archivedAt DateTime? @db.Timestamptz(6)

  /// Timestamp "consegna" (utile se in futuro inviamo anche email/push).
  deliveredAt DateTime? @db.Timestamptz(6)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([notificationId, userId])
  @@index([userId, isRead])
  @@index([userId, archivedAt])
  @@index([userId, createdAt(sort: Desc)])
  @@index([notificationId])
  @@schema("public")
}
