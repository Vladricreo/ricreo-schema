/// Modello generico per qualsiasi articolo gestito in inventario.
/// Può rappresentare materie prime, imballaggi, componenti, accessori, ricambi, attrezzi o prodotti finiti.
/// Il campo 'type' (ItemType) distingue la natura specifica dell'articolo.
model Item {
  id       String  @id @default(uuid()) @db.Uuid
  imageUrl String?
  name     String
  sku      String  @unique

  price            Decimal  @db.Decimal(12, 2) /// prima: Float
  weight           Decimal? @db.Decimal(12, 2) /// prima: Float?
  /// Tipologia di articolo (es. MATERIALE, IMBALLAGGIO, COMPONENTE).
  type             ItemType
  categoryId       String?  @db.Uuid
  colorId          String?  @db.Uuid
  brandId          String?  @db.Uuid
  supplierId       String?  @db.Uuid
  locationId       String?  @db.Uuid
  standardWeightId String?  @db.Uuid
  dimensionsId     String?  @db.Uuid

  properties Json?

  inStock  Int @default(0)
  reserved Int @default(0)
  onOrder  Int @default(0)
  minStock Int @default(0)
  maxStock Int @default(0)
  minOrder Int @default(0)
  maxOrder Int @default(0)

  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  packagingTypeId String?  @db.Uuid

  brand          Brand?             @relation(fields: [brandId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  category       Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  color          Color?             @relation(fields: [colorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  location       WarehouseLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  packagingType  PackagingType?     @relation(fields: [packagingTypeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  standardWeight StandardWeight?    @relation(fields: [standardWeightId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  supplier       Supplier?          @relation(fields: [supplierId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  dimensions     Dimensions?        @relation(fields: [dimensionsId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// Allocazioni multi-location per questo Item (quantità per slot).
  warehouseItemAllocations WarehouseItemAllocation[]

  movements Movement[]

  productComponents         ProductToComponent[]
  productPackages           ProductToPackage[]
  productTools              ProductToTool[]
  productUtilities          ProductToUtility[]
  parts                     ProductPart[]         @relation("ItemToItemPart")
  /// Distinta base (BOM) delle parti: materiali e grammi per singola parte.
  /// Nota: è separata da `parts` perché serve una join con campi (peso, note, ecc.).
  partMaterials             ProductPartMaterial[]
  ordersofitemforproduction ProductOrderItem[]
  purchaseOrderLines        PurchaseOrderLine[]
  product                   Product[]
  compatibleMachines        CompatibleMachine[]   @relation("SpareParts")
  OdetteContent             OdetteContent[]
  lots                      InventoryLot[]

  // Relazioni Print Farm
  projectFiles      ProjectThreeMFFile[]
  fileMaterialUsage ProjectFileMaterial[] @relation("FileMaterialUsage") // Uso materiale nei file con peso specifico
  productionJobs    ProductionJob[]
  printRuns         PrintRun[]
  spools            FilamentSpool[]
  filamentProfile   FilamentProfile? // Profilo tecnico per materiali (solo per type=MATERIAL)

  @@index([type])
  @@index([categoryId])
  @@index([colorId])
  @@index([brandId])
  @@index([supplierId])
  @@index([locationId])
  @@schema("inventory")
}

/// Modello per un prodotto finito, vendibile.
/// Un prodotto è composto da vari 'Item' (componenti, materiali) e può avere più fasi di assemblaggio.
/// Gestisce informazioni su costi, prezzi, e logistica (FBM/FBA).
model Product {
  id        String  @id @unique @default(uuid()) @db.Uuid
  imageUrl  String?
  treemfUrl String?
  name      String
  asin      String?
  ean       String?

  cost           Decimal  @default(0) @db.Decimal(12, 2) /// prima: Float
  estimatedPrice Decimal? @db.Decimal(12, 2) /// prima: Float?
  sellingPrice   Decimal? @db.Decimal(12, 2) /// prima: Float?
  profitMargin   Decimal? @db.Decimal(5, 4) /// prima: Float? (0.1234 = 12.34%)
  laborCost      Decimal? @db.Decimal(12, 2) /// prima: Float?
  laborMinutes   Decimal? @db.Decimal(8, 2) /// prima: Float?
  dimensionsId   String?  @db.Uuid

  itemId     String?  @db.Uuid
  properties Json?
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  skus Sku[]

  minStock Int @default(5)
  minOrder Int @default(0) // Lotto minimo di produzione (batching)

  // Campi per ottimizzazione dinamica (Velocity)
  averageDailySales    Decimal?  @db.Decimal(12, 2)
  suggestedMinStock    Int?
  autoAdjustMinStock   Boolean   @default(false)
  lastSalesCalculation DateTime? @db.Timestamptz(6)

  amazonProduct  AmazonProduct?
  stages         AssemblyStage[]
  guides         Guide[]
  warnings       Warning[]
  parts          ProductPart[]
  movements      Movement[]
  /// Relazione opzionale verso l'Item collegato
  item           Item?                @relation(fields: [itemId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  components     ProductToComponent[] @relation("ProductComponents")
  productOrders  ProductOrder[]
  packages       ProductToPackage[]   @relation("ProductPackages")
  tools          ProductToTool[]      @relation("ProductTools")
  utilities      ProductToUtility[]   @relation("ProductUtilities")
  shipments      Shipment[]
  assemblyOrders AssemblyOrder[]
  dimensions     Dimensions?          @relation(fields: [dimensionsId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  finishedAllocations FinishedAllocation[]
  lots                InventoryLot[]

  // Relazioni Print Farm
  projectFiles   ProjectThreeMFFile[]
  projectParts   ProjectPart[]
  productionJobs ProductionJob[]

  @@index([itemId])
  @@schema("inventory")
}

/// Rappresenta un sotto-assieme o una parte stampata in 3D di un 'ProductItem'.
model ProductPart {
  id                String                    @id @unique @default(uuid()) @db.Uuid
  imageUrl          String?
  name              String
  price             Decimal?                  @db.Decimal(12, 2) /// prima: Float?
  properties        Json?
  productId         String                    @db.Uuid
  quantityNeeded    Int                       @default(0)
  dimensionsId      String?                   @db.Uuid
  dimensions        Dimensions?               @relation(fields: [dimensionsId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  inStock           Int                       @default(0)
  onOrder           Int                       @default(0)
  product           Product                   @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  movements         Movement[]
  productOrders     ProductOrderProductPart[]
  materials         Item[]                    @relation("ItemToItemPart")
  /// Distinta base (BOM) della parte: materiali e grammi per singola parte.
  materialBreakdown ProductPartMaterial[]

  OdetteContent OdetteContent[]

  // Relazioni Print Farm
  projectParts   ProjectPart[]
  productionJobs ProductionJob[]

  @@index([productId])
  @@schema("inventory")
}

/// Distinta base (BOM) di una `ProductPart`: collega un materiale (`Item`) ai grammi usati per UNA singola parte.
/// Serve per avere più materiali e pesi per la stessa parte (es. multi-materiale / inserti).
model ProductPartMaterial {
  id String @id @default(uuid()) @db.Uuid

  productPartId String      @db.Uuid
  productPart   ProductPart @relation(fields: [productPartId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  materialId String @db.Uuid
  material   Item   @relation(fields: [materialId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  /// Grammi di questo materiale usati per UNA singola parte.
  usedWeight Decimal @default(0) @db.Decimal(12, 2)

  notes String?

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([productPartId, materialId])
  @@index([productPartId])
  @@index([materialId])
  @@schema("inventory")
}

model Dimensions {
  id            String          @id @unique @default(uuid()) @db.Uuid
  width         Decimal         @default(0) @db.Decimal(12, 2)
  height        Decimal         @default(0) @db.Decimal(12, 2)
  depth         Decimal         @default(0) @db.Decimal(12, 2)
  poductpart    ProductPart[]
  item          Item[]
  product       Product[]
  amazonProduct AmazonProduct[]
  odetteType    OdetteType[]
  sku           Sku[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@schema("inventory")
}

/// Rappresenta una singola fase nel processo di assemblaggio di un 'Product'.
/// Include informazioni come il tempo di assemblaggio, l'ordine e il tipo di fase.
model AssemblyStage {
  id                  String               @id @unique @default(uuid()) @db.Uuid
  imageUrl            String?
  name                String
  productId           String               @db.Uuid
  order               Int?                 @default(0)
  instock             Int?                 @default(0)
  description         String?
  /// Tempo in minuti richiesto per completare questa fase.
  assemblyTime        Int                  @default(0)
  type                AssemblyStageType    @default(ASSEMBLED)
  product             Product              @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  movements           Movement[]
  finishedAllocations FinishedAllocation[]

  assemblyOperations AssemblyOperation[]

  /// Relazioni many-to-many con Guide e Warning
  guideLinks   GuideToAssemblyStage[]
  warningLinks WarningToAssemblyStage[]

  /// Relazione con le utility assegnate a questa fase
  utilities ProductToUtility[]

  odetteContents OdetteContent[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([productId, name])
  @@index([productId])
  @@schema("inventory")
}

/// Guida di assemblaggio associata a un Product.
/// Puo essere associata a zero, uno o piu AssemblyStages tramite la tabella di join.
/// Se non ha stages associati, la guida si applica a tutto il prodotto.
model Guide {
  id           String  @id @default(uuid()) @db.Uuid
  title        String
  description  String? @db.Text
  url          String? /// URL esterno (es. YouTube, documentazione)
  imageUrl     String? /// URL immagine illustrativa
  fileUrl      String? /// URL file caricato (PDF o altro documento)
  order        Int     @default(0) /// Ordine di visualizzazione
  appliesToAll Boolean @default(true) /// Se true, si applica a tutte le fasi
  isnew        Boolean @default(false) /// Se true, la guida è nuova
  productId    String  @db.Uuid
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  /// Relazione many-to-many con AssemblyStage
  stages GuideToAssemblyStage[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([productId])
  @@schema("inventory")
}

/// Tabella di join per Guide e AssemblyStage (many-to-many)
model GuideToAssemblyStage {
  guideId         String @db.Uuid
  assemblyStageId String @db.Uuid

  guide         Guide         @relation(fields: [guideId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  assemblyStage AssemblyStage @relation(fields: [assemblyStageId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([guideId, assemblyStageId])
  @@index([assemblyStageId])
  @@schema("inventory")
}

/// Avviso di sicurezza/assemblaggio associato a un Product.
/// Puo essere associato a zero, uno o piu AssemblyStages tramite la tabella di join.
/// Se non ha stages associati, avviso si applica a tutto il prodotto.
model Warning {
  id           String          @id @default(uuid()) @db.Uuid
  type         WarningType     @default(OTHER)
  severity     WarningSeverity @default(MEDIUM)
  description  String          @db.Text
  imageUrl     String? /// URL immagine illustrativa
  order        Int             @default(0) /// Ordine di visualizzazione
  appliesToAll Boolean         @default(true) /// Se true, si applica a tutte le fasi
  isnew        Boolean         @default(false) /// Se true, l'avviso è nuovo
  productId    String          @db.Uuid
  product      Product         @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  /// Relazione many-to-many con AssemblyStage
  stages WarningToAssemblyStage[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([productId])
  @@index([severity])
  @@schema("inventory")
}

/// Tabella di join per Warning e AssemblyStage (many-to-many)
model WarningToAssemblyStage {
  warningId       String @db.Uuid
  assemblyStageId String @db.Uuid

  warning       Warning       @relation(fields: [warningId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  assemblyStage AssemblyStage @relation(fields: [assemblyStageId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([warningId, assemblyStageId])
  @@index([assemblyStageId])
  @@schema("inventory")
}

/// Definisce una categoria per raggruppare gli 'Item'.
/// Utile per l'organizzazione e il filtraggio.
model Category {
  id                 String         @id @default(uuid()) @db.Uuid
  name               String
  associatedItemType ItemType
  items              Item[]
  odetteTypes        OdetteType[]
  warehouseRows      WarehouseRow[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([name, associatedItemType])
  @@index([associatedItemType])
  @@index([name])
  @@schema("inventory")
}

/// Definisce un tipo di imballaggio per gli articoli (es. scatola, contenitore).
model PackagingType {
  id                 String         @id @default(uuid()) @db.Uuid
  name               String
  class              PackagingClass @default(PRIMARY)
  associatedItemType ItemType
  items              Item[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([name, associatedItemType])
  @@index([associatedItemType])
  @@index([name])
  @@schema("inventory")
}

/// Definisce un colore per gli 'Item', con codice esadecimale opzionale.
model Color {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String
  hexCode            String?
  associatedItemType ItemType
  items              Item[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([name, associatedItemType])
  @@index([associatedItemType])
  @@index([name])
  @@schema("inventory")
}

/// Definisce un marchio o brand per gli 'Item'.
model Brand {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String
  associatedItemType ItemType
  items              Item[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([name, associatedItemType])
  @@index([associatedItemType])
  @@index([name])
  @@schema("inventory")
}

/// Definisce un peso standard per un articolo, utile per calcoli logistici.
model StandardWeight {
  id                 String   @id @default(uuid()) @db.Uuid
  weight             Decimal  @db.Decimal(12, 2)
  associatedItemType ItemType
  items              Item[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([associatedItemType])
  @@schema("inventory")
}

/// Modello per le macchine compatibili con i ricambi ('SPARE_PART').
model CompatibleMachine {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String
  associatedItemType ItemType @default(SPARE_PART)
  spareParts         Item[]   @relation("SpareParts")

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([name, associatedItemType])
  @@index([name])
  @@index([associatedItemType])
  @@schema("inventory")
}

/// Tabella di join per associare un 'ProductItem' con i suoi imballaggi ('Item' di tipo 'PACKAGING').
model ProductToPackage {
  productId String  @db.Uuid
  itemId    String  @db.Uuid
  quantity  Int     @default(1)
  item      Item    @relation(fields: [itemId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  product   Product @relation("ProductPackages", fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([productId, itemId])
  @@index([itemId])
  @@schema("inventory")
}

/// Tabella di join per associare un 'ProductItem' con gli attrezzi ('Item' di tipo 'TOOL') necessari.
model ProductToTool {
  productId String  @db.Uuid
  itemId    String  @db.Uuid
  item      Item    @relation(fields: [itemId], references: [id], onDelete: Restrict)
  product   Product @relation("ProductTools", fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([productId, itemId])
  @@index([itemId])
  @@schema("inventory")
}

/// Tabella di join per associare un 'ProductItem' con le utility ('Item' di tipo 'UTILITY') necessarie.
/// Le utility sono consumabili assegnati a una specifica fase di assemblaggio.
model ProductToUtility {
  productId       String         @db.Uuid
  itemId          String         @db.Uuid
  quantity        Int            @default(1)
  assemblyStageId String?        @db.Uuid /// Fase di assemblaggio a cui è assegnata la utility
  item            Item           @relation(fields: [itemId], references: [id], onDelete: Restrict)
  product         Product        @relation("ProductUtilities", fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  assemblyStage   AssemblyStage? @relation(fields: [assemblyStageId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@id([productId, itemId])
  @@index([itemId])
  @@index([assemblyStageId])
  @@schema("inventory")
}

/// Tabella di join per associare un 'ProductItem' con i suoi componenti ('Item' di tipo 'COMPONENT').
model ProductToComponent {
  productId String  @db.Uuid
  itemId    String  @db.Uuid
  quantity  Int     @default(1)
  item      Item    @relation(fields: [itemId], references: [id], onDelete: Restrict)
  product   Product @relation("ProductComponents", fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([productId, itemId])
  @@index([itemId])
  @@schema("inventory")
}

/// Tipi di articoli gestibili dall'inventario.
enum ItemType {
  MATERIAL
  PACKAGING
  COMPONENT
  ACCESSORY
  SPARE_PART
  TOOL
  UTILITY
  PRODUCT
  ODETTE

  @@schema("inventory")
}

/// Tipo di fase di assemblaggio.
enum AssemblyStageType {
  /// DEPRECATO: non usare. La disponibilità "da parti" viene calcolata virtualmente.
  RAW
  ASSEMBLED // sotto-assieme assemblato
  FIRST_STAGE // prima fase di assemblaggio prodotto con packaging primario
  SECOND_STAGE // prodotto finito con packaging primario e secondario
  OTHER // altro

  @@schema("inventory")
}

/// Tipi di imballaggio: primario (a contatto col prodotto), secondario (scatola esterna), altro.
enum PackagingClass {
  PRIMARY
  SECONDARY
  OTHERS

  @@schema("inventory")
}

/// Tipo di avviso per il modello Warning
enum WarningType {
  SAFETY /// Sicurezza
  HANDLING /// Maneggiamento
  ASSEMBLY /// Assemblaggio
  QUALITY /// Qualità
  OTHER /// Altro

  @@schema("inventory")
}

/// Gravità dell'avviso per il modello Warning
enum WarningSeverity {
  LOW /// Bassa
  MEDIUM /// Media
  HIGH /// Alta
  CRITICAL /// Critica

  @@schema("inventory")
}
