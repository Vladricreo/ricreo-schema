/// Modello per il profilo di un utente, con informazioni aggiuntive come la biografia.
model Profile {
  id        Int     @id @default(autoincrement())
  bio       String?
  avatarUrl String?
  language  String? @default("it")
  userId    Int     @unique ///
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@schema("public")
}

/// Modello per gli utenti del sistema. Gestisce l'autenticazione e le informazioni di base dell'utente.
model User {
  id                  Int                 @id @default(autoincrement())
  email               String              @unique
  username            String              @unique
  password            String
  name                String?
  isActive            Boolean             @default(true)
  createdAt           DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime            @default(now()) @updatedAt @db.Timestamptz(6)
  posts               Post[]
  profile             Profile?
  roles               UserRole[]
  OdetteMove          OdetteMove[]
  OdetteCleaningLog   OdetteCleaningLog[]
  movements           Movement[]
  productOrders       ProductOrder[]
  assemblyOrders      AssemblyOrder[]
  performedOperations AssemblyOperation[]
  lotInspections      LotInspection[]

  /// Operazioni di raccolta pezzi effettuate da questo utente
  printerHarvests      PrinterHarvest[]      @relation("PrinterHarvests")
  /// Operazioni di carico filamento effettuate da questo utente
  printerFilamentLoads PrinterFilamentLoad[] @relation("PrinterFilamentLoads")

  /// Notifiche create da questo utente (audit/actor).
  notificationsCreated   Notification[]          @relation("NotificationCreatedBy")
  /// Stato notifiche ricevute da questo utente.
  notificationRecipients NotificationRecipient[]

  /// Notifiche Print Farm create da questo utente (audit/actor).
  printFarmNotificationsCreated PrintFarmNotification[] @relation("PrintFarmNotificationCreatedBy")
  /// Stato notifiche Print Farm ricevute da questo utente.
  printFarmNotificationRecipients PrintFarmNotificationRecipient[]

  @@index([isActive]) /// Indice pratico per filtri frequenti
  @@schema("public") ///  la tabella degli utenti
}

model Role {
  id          String           @id @default(uuid()) @db.Uuid
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime         @default(now()) @updatedAt @db.Timestamptz(6)
  users       UserRole[]
  permissions RolePermission[]

  @@schema("public")
}

model UserRole {
  userId     Int
  roleId     String   @db.Uuid
  assignedAt DateTime @default(now()) @db.Timestamptz(6)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@schema("public")
}

model Permission {
  id          String           @id @default(uuid()) @db.Uuid
  name        String           @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime         @default(now()) @updatedAt @db.Timestamptz(6)
  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@schema("public")
}

model RolePermission {
  roleId       String     @db.Uuid
  permissionId String     @db.Uuid
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@schema("public")
}
