/// Registro degli interventi di manutenzione sulla stampante.
model PrinterMaintenanceLog {
  id        String  @id @default(uuid()) @db.Uuid
  printerId String  @db.Uuid
  printer   Printer @relation(fields: [printerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  type        MaintenanceType @default(ROUTINE)
  description String

  performedAt DateTime @default(now()) @db.Timestamptz(6)
  performedBy String? // User ID

  cost        Decimal? @db.Decimal(12, 2) // Costo intervento/ricambi
  durationMin Int? // Durata intervento in minuti

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@schema("print-farm")
}

/// Issue "attiva" o storicizzata legata a una stampante.
/// A differenza di `PrinterLogs` (log puntuale di un ErrorCode), questa tabella serve a rappresentare
/// condizioni operative che bloccano la produzione (es. FILAMENT out, BED da scaricare, rete offline),
/// con lifecycle OPEN -> ACKED -> RESOLVED e aggiornamento `lastSeenAt`.
model PrinterIssue {
  id String @id @default(uuid()) @db.Uuid

  printerId String @db.Uuid
  printer   Printer @relation(fields: [printerId], references: [id], onDelete: Cascade)

  /// Se l'issue è correlata a un assignment specifico (stampa/coda).
  assignmentId String?            @db.Uuid
  assignment   PrinterAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)

  source   PrinterIssueSource   @default(MQTT)
  category PrinterIssueCategory
  status   PrinterIssueStatus   @default(OPEN)
  severity ErrorSeverity        @default(WARNING)

  /// Collegamento opzionale a una tabella di codici noti.
  errorCodeId Int?
  errorCode   ErrorCode? @relation(fields: [errorCodeId], references: [id], onDelete: SetNull)

  /// Codice esterno (es. raw code MQTT) se non mappato a ErrorCode.
  externalCode String?
  message      String?

  /// Quando l'issue è stata vista la prima volta / aggiornata.
  openedAt   DateTime @default(now()) @db.Timestamptz(6)
  lastSeenAt DateTime @default(now()) @db.Timestamptz(6)

  /// Gestione operativa
  acknowledgedAt DateTime? @db.Timestamptz(6)
  acknowledgedBy String? // User ID
  resolvedAt     DateTime? @db.Timestamptz(6)
  resolvedBy     String? // User ID

  /// Payload/contesto (raw MQTT/WSS, snapshot, ecc.)
  metadata Json?

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([printerId, status])
  @@index([printerId, category, status])
  @@index([assignmentId])
  @@index([errorCodeId])
  @@index([lastSeenAt])
  @@schema("print-farm")
}

/// Registro puntuale degli scarti/errori.
/// Permette di analizzare le cause di fallimento e ricalcolare i job.
model PrintFailureLog {
  id String @id @default(uuid()) @db.Uuid

  productionJobId String        @db.Uuid
  productionJob   ProductionJob @relation(fields: [productionJobId], references: [id])

  printerId String  @db.Uuid
  printer   Printer @relation(fields: [printerId], references: [id])

  /// Opzionale: se il fallimento è avvenuto durante una run specifica
  printRunId String?   @db.Uuid
  printRun   PrintRun? @relation(fields: [printRunId], references: [id])

  quantityScrapped Int           @default(1)
  reason           FailureReason @default(OTHER)
  notes            String?

  reportedAt DateTime @default(now()) @db.Timestamptz(6)
  reportedBy String? // User ID

  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@schema("print-farm")
}

/// Feedback degli operatori su stampanti o file.
/// Es: "Questa stampante fa rumore", "Questo file ha supporti impossibili".
model FarmFeedback {
  id String @id @default(uuid()) @db.Uuid

  type     FeedbackType     @default(GENERAL)
  priority FeedbackPriority @default(NORMAL)
  status   FeedbackStatus   @default(OPEN)

  description String

  // Il feedback può essere collegato a una stampante E/O a un file
  printerId String?  @db.Uuid
  printer   Printer? @relation(fields: [printerId], references: [id])

  fileId String?               @db.Uuid
  file   ProjectThreeMFFile?   @relation(fields: [fileId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  reportedBy String? // User ID
  resolvedBy String? // User ID

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@schema("print-farm")
}

enum MaintenanceType {
  ROUTINE // Pulizia, ingrassaggio
  REPAIR // Sostituzione pezzi rotti
  UPGRADE // Miglioria hardware
  CALIBRATION
  OTHER

  @@schema("print-farm")
}

/// Origine dell'issue (telemetria o operatore/scheduler).
enum PrinterIssueSource {
  MQTT
  WSS
  OPERATOR
  SCHEDULER

  @@schema("print-farm")
}

/// Categoria operativa/tecnica dell'issue.
enum PrinterIssueCategory {
  FILAMENT // fine filamento, carico/estrusione, AMS ecc
  BED // scarico piatto / adesione / pulizia
  PRINT // errore durante stampa
  NETWORK // offline / timeout
  MAINTENANCE // guasti / manutenzione richiesta
  SAFETY // sportello aperto, temperatura, ecc
  OTHER

  @@schema("print-farm")
}

/// Stato lifecycle dell'issue.
enum PrinterIssueStatus {
  OPEN
  ACKED
  RESOLVED

  @@schema("print-farm")
}

enum FailureReason {
  BED_ADHESION // Distacco dal piatto
  NOZZLE_CLOG // Ugello intasato
  FILAMENT_ISSUE // Filamento spezzato/finito/umido
  LAYER_SHIFT // Perdita passi
  POWER_LOSS // Blackout
  SPAGHETTI // Stampa nel vuoto
  QUALITY_ISSUE // Brutta finitura
  USER_ERROR // Errore operatore
  SLICING_ERROR // File corrotto/errato
  OTHER

  @@schema("print-farm")
}

enum FeedbackType {
  PRINTER_ISSUE
  FILE_ISSUE
  SLICING_IMPROVEMENT
  MODIFICATION_REQUEST // Richiesta di modifica del file
  GENERAL

  @@schema("print-farm")
}

enum FeedbackStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  WONT_FIX

  @@schema("print-farm")
}

enum FeedbackPriority {
  LOW
  NORMAL
  HIGH
  URGENT

  @@schema("print-farm")
}
