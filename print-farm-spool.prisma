/// Profilo tecnico di un filamento (collegato a Item di tipo MATERIAL).
/// Contiene tutte le specifiche per la stampa: temperature, codici BambuLab, etc.
model FilamentProfile {
  id String @id @default(uuid()) @db.Uuid

  // Collegamento all'Item (materiale)
  itemId String @unique @db.Uuid
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  // Codici esterni per integrazione
  bambuCode String? @unique // Es. "GFA00", "GFB00", "GFL99"

  // Temperature di stampa (°C)
  printTempMin Int? // Es. 190
  printTempMax Int? // Es. 220
  bedTempMin   Int? // Es. 45
  bedTempMax   Int? // Es. 60

  // Essiccazione
  dryingTemp      Int? // Es. 55
  dryingTimeHours Int? // Es. 8

  // Proprietà fisiche
  density  Decimal? @db.Decimal(5, 3) // g/cm³ per calcolo peso
  diameter Decimal  @default(1.75) @db.Decimal(4, 2) // mm

  // Compatibilità
  compatibleNozzles String[] // Es. ["Standard", "Hardened Steel"]

  // Velocità consigliate
  maxVolumetricSpeed Decimal? @db.Decimal(6, 2) // mm³/s

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@schema("print-farm")
}

/// Rappresenta una bobina fisica (o virtuale) di filamento.
/// UTILIZZO "SLOT VIRTUALE" (Consigliato per alti volumi):
/// 1. Quando si carica una bobina NUOVA, si crea un FilamentSpool con isVirtual=true e weight=1000g.
/// 2. Non serve etichettare la bobina fisica. L'ID esiste solo nel database associato alla stampante.
/// 3. Ogni stampa scala il peso da questa bobina.
/// 4. Quando finisce o viene rimossa (senza essere finita), si marca come ARCHIVED.
///    Se rimossa parzialmente e si vuole riusare: solo allora si etichetta fisicamente e si tiene isVirtual=false.
model FilamentSpool {
  id String @id @default(uuid()) @db.Uuid

  itemId String @db.Uuid
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict, onUpdate: Cascade) // Il tipo di materiale (es. PLA Nero)

  // Tracciamento Peso
  initialWeight   Decimal @db.Decimal(10, 2) // Peso netto iniziale (es. 1000g)
  remainingWeight Decimal @db.Decimal(10, 2) // Peso stimato residuo

  // Stato
  isVirtual Boolean     @default(true) // True = Nessuna etichetta fisica, esiste solo "montata" sulla stampante
  status    SpoolStatus @default(ACTIVE)

  // Tracciabilità
  lotCode        String? // Lotto del produttore (facoltativo, per qualità ISO)
  /// Lotto di inventario associato a questa bobina (acquisto o produzione interna).
  /// Permette di risalire al fornitore o al lotto di produzione anche via spool.
  inventoryLotId String?       @db.Uuid
  inventoryLot   InventoryLot? @relation("InventoryLotFilamentSpools", fields: [inventoryLotId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// ID del gettone RFID/NFC fisico associato temporaneamente.
  /// FLUSSO "GETTONE RIUTILIZZABILE":
  /// 1. Si usa un set di gettoni fisici (es. clip stampate con tag NFC).
  /// 2. Quando una bobina parziale viene messa a magazzino, si attacca un gettone libero.
  /// 3. Si associa l'ID del gettone a questa FilamentSpool (nfcTagId = "TOKEN-123").
  /// 4. Quando la bobina viene rimontata o finisce, si stacca il gettone (nfcTagId = null).
  /// 5. Il gettone torna nel cesto pronto per un'altra bobina.
  nfcTagId String? @unique

  openedAt   DateTime  @default(now()) @db.Timestamptz(6) // Per scadenza/umidità
  finishedAt DateTime? @db.Timestamptz(6)

  // Dove si trova?
  mountedOnId String?  @db.Uuid // ID Stampante se montata
  mountedOn   Printer? @relation("MountedSpool", fields: [mountedOnId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  activeOnPrinters Printer[] @relation("ActiveSpool")

  printRuns PrintRun[] // Storico stampe fatte con questa bobina

  /// Operazioni di carico filamento in cui è stata usata questa bobina
  filamentLoads PrinterFilamentLoad[]

  /// Posizione in magazzino (quando non montata su stampante).
  /// Usata per bobine parziali stoccate in attesa di riutilizzo.
  locationId String?            @db.Uuid
  location   WarehouseLocation? @relation("SpoolLocation", fields: [locationId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// Slot AMS in cui è caricata questa spool (per stampanti con AMS).
  /// Se presente, indica che la spool è in uno slot AMS specifico.
  amsSlot PrinterAmsSlot? @relation("AmsSlotSpool")

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([inventoryLotId])
  @@index([locationId])
  @@schema("print-farm")
}

enum SpoolStatus {
  ACTIVE // In uso o pronta all'uso
  DEPLETED // Finita (0g o scarto)
  ARCHIVED // Rimossa e non più tracciata (es. buttata parziale o persa)

  @@schema("print-farm")
}

/// Slot AMS di una stampante.
/// Ogni stampante con AMS può avere fino a 4 unità (A-D), ciascuna con 4 slot (1-4).
/// Questo model traccia quale spool è caricata in ogni slot.
model PrinterAmsSlot {
  id String @id @default(uuid()) @db.Uuid

  /// Stampante a cui appartiene lo slot
  printerId String  @db.Uuid
  printer   Printer @relation("PrinterAmsSlots", fields: [printerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  /// Unità AMS (0-3 = A, B, C, D)
  amsUnit Int

  /// Slot all'interno dell'unità (0-3 = slot 1-4)
  slot Int

  /// Spool attualmente caricata in questo slot (null = slot vuoto)
  /// @unique perché una spool può stare in un solo slot AMS alla volta
  spoolId String?        @unique @db.Uuid
  spool   FilamentSpool? @relation("AmsSlotSpool", fields: [spoolId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  /// Snapshot "reported" dalla stampante (NON tracciamento spool).
  /// Serve per salvare materiale/colore anche quando non abbiamo una FilamentSpool assegnata.
  /// Non deve sovrascrivere la spool "reale" (spoolId) scelta dal frontend.
  reportedMaterialType String? // es. "PLA", "ABS", "PETG"
  reportedColor        String? // es. "BLACK", "RED", "#FF0000" (best-effort)
  reportedTrayInfoIdx  String? // es. "GFB99" (Bambu tray_info_idx) - opzionale
  reportedLastSeenAt   DateTime? @db.Timestamptz(6)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  /// Un solo record per combinazione stampante + unità + slot
  @@unique([printerId, amsUnit, slot])
  @@index([printerId])
  @@index([spoolId])
  @@schema("print-farm")
}

